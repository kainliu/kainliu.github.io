<!-- home > archives > notes > about > posts (null)--><!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Behind A Random String Generator | Westworld</title><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Asar|Imprima"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/images/blog-logo.png"><link rel="apple-touch-icon" href="/images/blog-logo.png"><link rel="apple-touch-icon-precomposed" href="/images/blog-logo.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div id="header"><div class="body_container"><div class="site-name"><h1 class="hidden">Behind A Random String Generator</h1><a id="logo" href="/."><img src="/images/blog-logo.png" class="blog-logo nofancybox"><span>Westworld</span></a><p class="description"></p></div><div id="nav-menu"><a href="/"><i class="fa fa-rocket"> Home</i></a><a href="/archives/"><i class="fa fa-sitemap"> Archives</i></a><a href="/about/"><i class="fa fa-user-circle"> About</i></a></div></div></div><div id="layout" class="pure-g body_container"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><div class="post-header"><div class="screen-wide-bg"><div class="post-header-container"><i class="post-thumbnail"><img src="/images/coin.png" class="nofancybox"/></i><h1 class="post-title">Behind A Random String Generator</h1><div class="post-desc">Randomness origins from an elegant design of hardware.</div><div class="post-meta"><span class="author">Kai</span><span class="date">2012-05-11</span></div></div></div></div><div class="post-content"><p>It starts when I play with the javascript source codes of <code>Google Translate</code>. There is an interesting line:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Math</span>.floor(<span class="number">2147483648</span> * <span class="built_in">Math</span>.random()).toString(<span class="number">36</span>);</span><br></pre></td></tr></table></figure>
<p>which generates a random 6-character string, e.g. <code>2qa2xe</code>.</p>
<ol>
<li><p><code>Math.toString()</code></p>
<p> When the string converted from the random number in 36 decimal, the characters are selected from $[0-9] \cup [a-z]$.</p>
 <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">35</span>;</span><br><span class="line">a.toString();   <span class="comment">//"35"</span></span><br><span class="line">a.toString(<span class="number">2</span>);  <span class="comment">//"100011"</span></span><br><span class="line">a.toString(<span class="number">36</span>); <span class="comment">//"z"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>2147483648</code></p>
<p> I found out that this magic number is $2^{31}$.  Since <code>Math.random()</code> returns a float between $[0,1)$,</p>
 <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Math</span>.floor(<span class="number">2147483648</span> * <span class="built_in">Math</span>.random())</span><br></pre></td></tr></table></figure>
<p> returns an integer between $[0, 2147483648)$. The ‘largest’ string is <code>zik0zj</code>.</p>
</li>
</ol>
<p>So in my opinion, this line is used as a light-weight random string generator, which could be used to identify the users or sessions.</p>
<p>For example, we want to generate a 6-character random string.<br>The number corresponding with the max 6 character string <code>zzzzzz</code> is $36^{6} - 1$</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">N = <span class="number">6</span></span><br><span class="line"><span class="comment">// 0 - zzzzzz</span></span><br><span class="line"><span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.pow(<span class="number">36</span>, N) * <span class="built_in">Math</span>.random()).toString(<span class="number">36</span>);</span><br></pre></td></tr></table></figure>
<p>With little efforts we could extend it to a full generator:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A random string generator</span></span><br><span class="line"><span class="comment">// @Input: &#123;Integer&#125; string length</span></span><br><span class="line"><span class="comment">// @Output: &#123;String&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomString</span>(<span class="params">N</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// force input to legal integer, otherwise set to default</span></span><br><span class="line">  <span class="keyword">if</span>(!<span class="built_in">parseInt</span>(N,<span class="number">10</span>)) N = <span class="number">6</span></span><br><span class="line">  <span class="comment">// generator string from random number</span></span><br><span class="line">  <span class="keyword">var</span> rs = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.pow(<span class="number">36</span>, N) * <span class="built_in">Math</span>.random()).toString(<span class="number">36</span>);</span><br><span class="line">  <span class="comment">// if the new string is short than N, add 0 on the left</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">Math</span>.pow(<span class="number">10</span>, N) + rs).substr(-N);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Underneath-the-functions"><a href="#Underneath-the-functions" class="headerlink" title="Underneath the functions"></a>Underneath the functions</h2><p><code>Math.random()</code> may be the most frequently used functions, and almost all mainstream languages have built-in implementations.</p>
<p>Most Javascript engines use a <a href="https://en.wikipedia.org/wiki/Pseudorandom_number_generator" target="_blank" rel="noopener">pseudo-random number generator(PRNG)</a>, in which the random number is derived from an internal state and calculated by a fixed algorithm. <a href="https://docs.python.org/2/library/random.html" target="_blank" rel="noopener">Python</a> <code>random</code> module also uses pseudo-random number generators with the underlying implementation in C.</p>
<p>I found an interesting implementation in github repository of <a href="https://github.com/v8/v8/blob/ca6e40d7ba853319c15196fef3f4536c8b3929fe/benchmarks/spinning-balls/v.js" target="_blank" rel="noopener">Chrome v8</a>, in a benchmark implementation.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// To make the benchmark results predictable, we replace Math.random</span></span><br><span class="line"><span class="comment">// with a 100% deterministic alternative.</span></span><br><span class="line"><span class="built_in">Math</span>.random = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> seed = <span class="number">49734321</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Robert Jenkins' 32 bit integer hash function.</span></span><br><span class="line">    seed = ((seed + <span class="number">0x7ed55d16</span>) + (seed &lt;&lt; <span class="number">12</span>))  &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    seed = ((seed ^ <span class="number">0xc761c23c</span>) ^ (seed &gt;&gt;&gt; <span class="number">19</span>)) &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    seed = ((seed + <span class="number">0x165667b1</span>) + (seed &lt;&lt; <span class="number">5</span>))   &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    seed = ((seed + <span class="number">0xd3a2646c</span>) ^ (seed &lt;&lt; <span class="number">9</span>))   &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    seed = ((seed + <span class="number">0xfd7046c5</span>) + (seed &lt;&lt; <span class="number">3</span>))   &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    seed = ((seed ^ <span class="number">0xb55a4f09</span>) ^ (seed &gt;&gt;&gt; <span class="number">16</span>)) &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    <span class="keyword">return</span> (seed &amp; <span class="number">0xfffffff</span>) / <span class="number">0x10000000</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>It overrides original function and delivers a fixed sequence of “random” number, which is determined by the <code>seed</code>.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># the sequences are deterministic given a particular seed:</span></span><br><span class="line">&gt; Math.random()</span><br><span class="line">  <span class="number">0.9872818551957607</span></span><br><span class="line">&gt; Math.random()</span><br><span class="line">  <span class="number">0.34880331158638</span></span><br><span class="line">&gt; Math.random()</span><br><span class="line">  <span class="number">0.5631933622062206</span></span><br><span class="line">&gt; Math.random()</span><br><span class="line">  <span class="number">0.9990169629454613</span></span><br><span class="line">&gt; Math.random()</span><br><span class="line">  <span class="number">0.8291510976850986</span></span><br></pre></td></tr></table></figure>
<p>Moreover, from the comments, we could have these inferences:</p>
<ol>
<li>this alternative <code>Math.random</code> is deterministic by the seed, to make sure benchmarks are measured in the same way.</li>
<li>the original <code>Math.random</code> should not be 100% deterministic, at least on time-consuming performance.</li>
<li>this alternative should not be computationally expensive with a 32-bit internal state.</li>
</ol>
<p><em>Yang Guo</em> from V8 project <a href="https://v8project.blogspot.nl/2015/12/theres-mathrandom-and-then-theres.html" target="_blank" rel="noopener">has an introduction</a> about how they upgrade from  the 64-bit internal state algorithm to the new 128-bit one, called <a href="http://vigna.di.unimi.it/ftp/papers/xorshiftplus.pdf" target="_blank" rel="noopener">xorshift128+</a>.</p>
<p>Of course the solution of adding more bits ($N$) is effective to make random numbers hard to repeat themselves (permutation cycle is $2^{N}$), but, how to get a randomly chosen seed – <strong>a pure spark</strong>?</p>
<p><img src="/images/dices.jpg" alt="Dices are random number generators when each surface equally shaped."></p>
<h2 id="Chaos-Uncertainty-Randomness"><a href="#Chaos-Uncertainty-Randomness" class="headerlink" title="Chaos, Uncertainty, Randomness"></a>Chaos, Uncertainty, Randomness</h2><p>Predictable states are unavoidable in computers, while the chaotic universe is full of randomness around us, such as <a href="https://en.wikipedia.org/wiki/Brownian_motion" target="_blank" rel="noopener">Brownian motion</a>, the movement of atoms or molecules.</p>
<p>The question is how to capture it, and in an efficient way.</p>
<p>I heard about that in the ancient era of Windows XP, one black magic is to apply an IE plugin to access the current voice input, to get such random variables. The white-noise signals provide very reliable source and thus the JavaScript module could later use it as the unique-id. Though the details are not introduced, I believe it’s feasible.</p>
<p>At that time I started to think about how to capture such chaotic signals.</p>
<p>The <a href="http://spectrum.ieee.org/computing/hardware/behind-intels-new-randomnumber-generator" target="_blank" rel="noopener">article</a> by <em>Greg Taylor</em> and <em>George Cox</em> introduces their efforts on Intel’s new random number generator. From this we learned that there have been successful trials to generate random numbers with circuits, however, the cost of energy was one of the biggest shortcomings. Their new solution was fabulous:</p>
<p><img src="/images/random-number-transistor2.jpg" alt="Uncertain Circuits"></p>
<blockquote>
<p>Uncertain Circuits : When transistor 1 and transistor 2 are switched on, a coupled pair of inverters force Node A and Node B into the same state [left]. When the clock pulse rises [yellow, right], these transistors are turned off. Initially the output of both inverters falls into an indeterminate state, but random thermal noise within the inverters soon jostles one node into the logical 1 state and the other goes to logical 0.</p>
</blockquote>
<p>The circuits take advantage of the physically random properties of the thermal noise to generate a random binary outcome – a pure spark.</p>
<p><img src="/images/intel-random-number-generator.jpg" alt="Intel random number generator"></p>
<p>In practice, the electric features of transistors are never exactly the same, so there will be more one state than another statistically. However we require them to be almost equally distributed with 0s/1s. Given a long stream of raw bits from the <code>circuit</code>, a <code>conditioner</code> is set to monitor the frequency of 0s/1s, to fix the bias and correlation in the long term. Next, the stream from conditioner is sent to <code>PRNG</code>, then we will have the random number.</p>
<p><strong>I feel this should be the first lesson of my bachelor study on Analog/Digital Circuits. It unveils the design of fundamental graceful hardwares for a commonly used function, and vividly points out the importance of understanding fundamental technologies.</strong> For me, it is very exciting to see such a beautiful solution, and to enjoy the progress to think deeper.</p>
<p>Another question just occurred to me: is such randomness related with <em>Quantum Communication</em>, if yes, is it taking advantage of the uncertainty in atomic level?</p>
<h3 id="Aside-Random-numbers-in-Crypto-Safety"><a href="#Aside-Random-numbers-in-Crypto-Safety" class="headerlink" title="Aside: Random numbers in Crypto Safety"></a>Aside: Random numbers in Crypto Safety</h3><p>As <em>Yang Guo</em> points out <a href="https://v8project.blogspot.nl/2015/12/theres-mathrandom-and-then-theres.html" target="_blank" rel="noopener">in the blog</a> that:</p>
<blockquote>
<p>Even though <em>xorshift128+</em> is a huge improvement.., it still is not cryptographically secure. For use cases such as hashing, signature generation, and encryption/decryption, ordinary PRNGs are unsuitable. The Web Cryptography API introduces <em>window.crypto.getRandomValues</em>, a method that returns cryptographically secure random values, at a performance cost.</p>
</blockquote>
<p>Python docs also give a <a href="https://docs.python.org/2/library/random.html#random.jumpahead" target="_blank" rel="noopener">warning</a>:</p>
<blockquote>
<p>Warning: The pseudo-random generators of this module should not be used for security purposes. Use <em>os.urandom()</em> or <em>SystemRandom</em> if you require a cryptographically secure pseudo-random number generator.</p>
</blockquote>
<p>Generally, <em>cryptographically secure</em> means <strong>even if the attackers know the current state of this generator (or guess correctly), it’s still infeasible to get the next state with reasonable computational power</strong>.</p>
<p>It is very clear that they suggested using cryptographically secure pseudo-random number generator <a href="https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator" target="_blank" rel="noopener">CSPRNG</a> instead of PRNG in safety-sensitive scenes.</p>
</div><div class="post-meta"><div class="tags"><a href="/tags/javascript/">javascript</a><a href="/tags/hardware/">hardware</a><a href="/tags/circuits/">circuits</a><!-- tag.name--></div></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><div><a data-url="http://westworld.name/posts/behind-a-random-string-generator/" data-id="cjkq38byp00105iqb54wlvr27" class="article-share-link">Share</a></div><div id="disqus_show" class="readmore"><a class="show-comments" href="javascript:return false;"><span class="disqus-comment-count" data-disqus-identifier="posts/behind-a-random-string-generator/"> Comments</span></a></div><div id="disqus_thread"></div><script>// Requires jQuery of course.
$(document).ready(function() {
    $('.show-comments').on('click', function(){
        var disqus_shortname = 'kaigithub';
        // ajax request to load the disqus javascript
        $.ajax({
                type: "GET",
                url: "//" + disqus_shortname + ".disqus.com/embed.js",
                dataType: "script",
                cache: true
        });
        // hide the button once comments load
        $(this).fadeOut();
    });
});
</script><script id="dsq-count-scr" src="//kaigithub.disqus.com/count.js" async></script><div id="post_nav_container" class="screen-wide-bg">  <div class="post-nav pure-u-1 pure-u-md-4-4"><div class="pure-u-md-1-2"><a href="/posts/find-similar-images-based-on-locality-sensitive-hashing/" class="pre"><span>Find Similar Images Based On Locality Sensitive Hashing</span><i><img src="/images/image-search.png" class="nofancybox"></i></a></div><div class="pure-u-md-1-2"> <a href="/posts/arguments-and-interface-in-javascript/" class="next"><span>Arguments and Interface in Javascript</span><i><img src="/images/app.png" class="nofancybox"></i></a></div></div></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer"><p>© <a href="/." rel="nofollow">Westworld.</a><span> Site Generated by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo. </a></span></p><p> <span> Theme modified from <a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo">Maupassant. </a></span><span>Icons from <a rel="nofollow" target="_blank" href="http://www.flaticon.com">Flaticon </a>are licensed by CC 3.0 BY.</span></p></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    preview: "none"
  }
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></body></html>